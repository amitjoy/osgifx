name: ðŸš€ Release (npm Only)

on:
   push:
       branches: ['release/*']
   workflow_dispatch:

# Only one release at a time
concurrency:
   group: ${{ github.workflow }}
   cancel-in-progress: false

permissions:
   contents: write       # For creating releases
   packages: write       # For publishing packages
   id-token: write       # For sigstore signing

env:
   LC_ALL: en_US.UTF-8
   GRADLE_OPTS: "-Dorg.gradle.daemon=false"

jobs:
   release:
      name: ðŸŽ¯ Release npm ${{ github.ref_name }}
      runs-on: ubuntu-latest
      
      steps:
      -  name: ðŸ“¥ Checkout code
         uses: actions/checkout@v6
         with:
            fetch-depth: 0  # Full history for changelog generation
      
      -  name: ðŸ”’ Validate Gradle wrapper
         uses: gradle/wrapper-validation-action@v1
      
      -  name: â˜• Set up Java 25 with JavaFX
         uses: actions/setup-java@v5
         with:
            distribution: 'zulu'
            java-version: '25'
            java-package: jdk+fx
            cache: 'gradle'
      
      -  name: ðŸ˜ Setup Gradle
         uses: gradle/actions/setup-gradle@v3
         with:
            cache-read-only: false
      
      -  name: ðŸ“¦ Set up Node.js
         uses: actions/setup-node@v4
         with:
            node-version: '20'
            registry-url: 'https://registry.npmjs.org'
      
      -  name: âš™ï¸ Configure Git
         run: |
            git config user.name "GitHub Actions Bot"
            git config user.email "github-actions[bot]@users.noreply.github.com"
      
      -  name: ðŸ˜ Build Bundles
         run: ./gradlew clean build --info

      -  name: ðŸ“¦ Export Executable JAR
         run: ./gradlew :com.osgifx.console.product:export.osgifx --info

      -  name: ðŸ“¦ Copy Uberjar for jdeploy
         run: |
            mkdir -p com.osgifx.console.dist/uberjar
            cp com.osgifx.console.product/target/distributions/executable/osgifx.jar com.osgifx.console.dist/uberjar/osgifx.jar
      
      -  name: ðŸ“¢ Publish to npm
         if: ${{ inputs.dry_run != true }}
         run: npx jdeploy publish
         env:
            NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      -  name: ðŸ“ Generate release summary
         if: success()
         run: |
            echo "## ðŸŽ‰ Release ${{ github.ref_name }} Published" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Published Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- **Maven Central**: \`com.osgifx:osgifx:${GITHUB_REF_NAME#v}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **npm**: \`osgifx@${GITHUB_REF_NAME#v}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
            echo "- [Maven Central](https://central.sonatype.com/artifact/com.osgifx/osgifx)" >> $GITHUB_STEP_SUMMARY
            echo "- [npm Package](https://www.npmjs.com/package/osgifx)" >> $GITHUB_STEP_SUMMARY