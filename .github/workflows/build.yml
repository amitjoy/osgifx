name: ğŸ”¨ CI Build

on:
   push:
      branches: [main, master]
   pull_request:
      branches: [main, master]

# Cancel in-progress runs for the same workflow + branch/PR
concurrency:
   group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
   cancel-in-progress: true

permissions:
   contents: read

env:
   LC_ALL: en_US.UTF-8
   GRADLE_OPTS: "-Dorg.gradle.daemon=false"

jobs:
   build:
      name: ğŸ—ï¸ Build on ${{ matrix.config.os }}
      runs-on: ${{ matrix.config.os }}
      strategy:
         fail-fast: false  # Don't cancel other jobs if one fails
         matrix:
            config:
            -  os: ubuntu-latest
            -  os: macos-latest
            -  os: windows-latest
      
      steps:
      -  name: ğŸ“¥ Checkout code
         uses: actions/checkout@v6
         with:
            fetch-depth: 0  # Full history for better caching
      
      -  name: ğŸ”’ Validate Gradle wrapper
         uses: gradle/wrapper-validation-action@v1
      
      -  name: â˜• Set up Java 21 with JavaFX
         uses: actions/setup-java@v5
         with:
            distribution: 'zulu'
            java-version: '21'
            java-package: jdk+fx
            cache: 'gradle'  # Enable Gradle dependency caching
      
      -  name: ğŸ˜ Setup Gradle
         uses: gradle/actions/setup-gradle@v3
         with:
            cache-read-only: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master' }}
      
      -  name: ğŸ”¨ Build workspace
         run: ./gradlew build --max-workers=5 --parallel --scan
      
      -  name: ğŸ” Resolve product
         run: ./gradlew :com.osgifx.console.product:resolve.osgifx
      
      -  name: ğŸ“¦ Build executable JAR
         run: ./gradlew :com.osgifx.console.product:export.osgifx
      
      -  name: â¬†ï¸ Upload build artifacts
         if: always() && matrix.config.os == 'ubuntu-latest'
         uses: actions/upload-artifact@v4
         with:
            name: osgifx-jar-${{ github.sha }}
            path: com.osgifx.console.product/target/distributions/executable/osgifx.jar
            retention-days: 7